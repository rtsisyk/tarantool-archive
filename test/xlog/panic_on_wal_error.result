-- preparatory stuff
env = require('test_run')
---
...
test_run = env.new()
---
...
fio = require('fio')
---
...
glob = fio.pathjoin(box.cfg.wal_dir, '*.xlog')
---
...
for _, file in pairs(fio.glob(glob)) do fio.unlink(file) end
---
...
glob = fio.pathjoin(box.cfg.vinyl_dir, '*.vylog')
---
...
for _, file in pairs(fio.glob(glob)) do fio.unlink(file) end
---
...
glob = fio.pathjoin(box.cfg.memtx_dir, '*.snap')
---
...
for _, file in pairs(fio.glob(glob)) do fio.unlink(file) end
---
...
test_run:cmd("restart server default")
box.schema.user.grant('guest', 'replication')
---
...
_ = box.schema.space.create('test')
---
...
_ = box.space.test:create_index('pk')
---
...
--
-- reopen xlog
--
test_run:cmd("restart server default")
box.space.test ~= nil
---
- true
...
-- insert some stuff
-- 
box.space.test:auto_increment{'before snapshot'}
---
- [1, 'before snapshot']
...
--
-- this snapshot will go to the replica
--
box.snapshot()
---
- ok
...
-- 
-- create a replica, let it catch up somewhat
--
test_run:cmd("create server replica with rpl_master=default, script='xlog/replica.lua'")
---
- true
...
test_run:cmd("start server replica")
---
- true
...
test_run:cmd("switch replica")
---
- true
...
box.space.test:select{}
---
- - [1, 'before snapshot']
...
-- 
-- stop replica, restart the master, insert more stuff
-- which will make it into an xlog only
--
test_run:cmd("switch default")
---
- true
...
test_run:cmd("stop server replica")
---
- true
...
box.space.test:auto_increment{'after snapshot'}
---
- [2, 'after snapshot']
...
box.space.test:auto_increment{'after snapshot - one more row'}
---
- [3, 'after snapshot - one more row']
...
--
-- save snapshot and remove xlogs
-- 
box.snapshot()
---
- ok
...
fio = require('fio')
---
...
glob = fio.pathjoin(box.cfg.wal_dir, '*.xlog')
---
...
files = fio.glob(glob)
---
...
for _, file in pairs(files) do fio.unlink(file) end
---
...
test_run:cmd("restart server default")
--
-- make sure the server has some xlogs, otherwise the
-- replica doesn't discover the gap in the logs
--
box.space.test:auto_increment{'after snapshot and restart'}
---
- [4, 'after snapshot and restart']
...
box.space.test:auto_increment{'after snapshot and restart - one more row'}
---
- [5, 'after snapshot and restart - one more row']
...
--  
--  check that panic is true
--
box.cfg{force_recovery=false}
---
...
box.cfg.force_recovery
---
- false
...
-- 
-- try to start the replica, ha-ha
-- (replication should fail, some rows are missing)
--
test_run:cmd("start server replica")
---
- true
...
test_run:cmd("switch replica")
---
- true
...
fiber = require('fiber')
---
...
while box.info.replication[1].upstream.status ~= "stopped" do fiber.sleep(0.001) end
---
...
box.info.replication[1].upstream.status
---
- stopped
...
box.info.replication[1].upstream.message
---
- 'Missing .xlog file between LSN 6 {1: 6} and 8 {1: 8}'
...
box.space.test:select{}
---
- - [1, 'before snapshot']
...
--
--
test_run:cmd("switch default")
---
- true
...
test_run:cmd("stop server replica")
---
- true
...
test_run:cmd("cleanup server replica")
---
- true
...
--
-- cleanup
box.space.test:drop()
---
...
box.schema.user.revoke('guest', 'replication')
---
...
